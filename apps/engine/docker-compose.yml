# LinkFlow Go Engine - Complete Stack
# All 8 microservices for full workflow execution engine
#
# Standalone:
#   cd infra && docker-compose up -d    # Start Postgres + Redis first
#   docker-compose up -d                # Start core services
#   docker-compose --profile edge up -d # Include edge service
#
# Full stack (from project root):
#   docker-compose up -d                # Everything via include

x-common-env: &common-env
  DATABASE_URL: postgres://${POSTGRES_USER:-linkflow}:${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD}@linkflow-postgres:5432/${POSTGRES_DB:-linkflow}?sslmode=require&search_path=workflow # In production, use Docker secrets instead of env vars
  REDIS_URL: redis://:${REDIS_PASSWORD:?Set REDIS_PASSWORD}@linkflow-redis:6379
  LOG_LEVEL: ${LOG_LEVEL:-info}
  LOG_FORMAT: json

x-common-config: &common-config
  restart: unless-stopped
  networks:
    - linkflow
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"
  deploy:
    resources:
      limits:
        memory: 512M
        cpus: '1.0'

services:
  # ============================================
  # 1. FRONTEND SERVICE - API Gateway
  # ============================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: frontend
    container_name: linkflow-frontend
    <<: *common-config
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      <<: *common-env
      SERVICE_NAME: frontend
      HTTP_PORT: 8080
      GRPC_PORT: 9090
      HISTORY_ADDR: linkflow-history:7234
      MATCHING_ADDR: linkflow-matching:7235
      VISIBILITY_ADDR: linkflow-visibility:7237
      JWT_SECRET: ${JWT_SECRET:?Set JWT_SECRET}
      RATE_LIMIT_REQUESTS: 1000
      RATE_LIMIT_WINDOW: 60s
      ENGINE_PARTITION_COUNT: ${ENGINE_PARTITION_COUNT:-16}
      JOB_CONSUMER_GROUP: engine-group
      JOB_CLAIM_MIN_IDLE: 30s
      JOB_CLAIM_BATCH: 50
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      history:
        condition: service_healthy
      matching:
        condition: service_healthy

  # ============================================
  # 2. HISTORY SERVICE - Event Sourcing
  # ============================================
  history:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: history
    container_name: linkflow-history
    <<: *common-config
    environment:
      <<: *common-env
      SERVICE_NAME: history
      GRPC_PORT: 7234
      HTTP_PORT: 8080
      SHARD_COUNT: 16
      MATCHING_ADDR: linkflow-matching:7235
      TIMER_ADDR: linkflow-timer:7238
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # 3. MATCHING SERVICE - Task Queue
  # ============================================
  matching:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: matching
    container_name: linkflow-matching
    <<: *common-config
    environment:
      <<: *common-env
      SERVICE_NAME: matching
      GRPC_PORT: 7235
      HTTP_PORT: 8080
      PARTITION_COUNT: 4
      TASK_QUEUE_SYNC_INTERVAL: 1s
      LONG_POLL_TIMEOUT: 60s
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # 4. WORKER SERVICE - Node Executor
  # ============================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: worker
    container_name: linkflow-worker
    <<: *common-config
    environment:
      <<: *common-env
      SERVICE_NAME: worker
      HTTP_PORT: 8080
      MATCHING_ADDR: linkflow-matching:7235
      HISTORY_ADDR: linkflow-history:7234
      TASK_QUEUE: workflows-high,workflows-default,workflows-low,default
      NUM_WORKERS: 4
      POLL_INTERVAL: 1s
      CALLBACK_URL: http://linkflow-api:8000/api/v1/jobs/callback
      CALLBACK_SECRET: ${LINKFLOW_SECRET:?Set LINKFLOW_SECRET}
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    depends_on:
      matching:
        condition: service_healthy

  # ============================================
  # 5. TIMER SERVICE - Scheduling
  # ============================================
  timer:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: timer
    container_name: linkflow-timer
    <<: *common-config
    environment:
      <<: *common-env
      SERVICE_NAME: timer
      GRPC_PORT: 7238
      HTTP_PORT: 8080
      HISTORY_ADDR: linkflow-history:7234
      SCAN_INTERVAL: 1s
      BATCH_SIZE: 100
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      history:
        condition: service_healthy

  # ============================================
  # 6. VISIBILITY SERVICE - Search & Query
  # ============================================
  visibility:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: visibility
    container_name: linkflow-visibility
    <<: *common-config
    environment:
      <<: *common-env
      SERVICE_NAME: visibility
      GRPC_PORT: 7237
      HTTP_PORT: 8080
      ELASTICSEARCH_URL: ${ELASTICSEARCH_URL:-}
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # 7. EDGE SERVICE (Optional)
  # ============================================
  edge:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: edge
    container_name: linkflow-edge
    <<: *common-config
    environment:
      <<: *common-env
      SERVICE_NAME: edge
      HTTP_PORT: 8080
      FRONTEND_ADDR: linkflow-frontend:9090
      SYNC_INTERVAL: 30s
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    profiles:
      - edge

  # ============================================
  # 8. CONTROL PLANE (Optional)
  # ============================================
  control-plane:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: control-plane
    container_name: linkflow-control-plane
    <<: *common-config
    environment:
      <<: *common-env
      SERVICE_NAME: control-plane
      GRPC_PORT: 7239
      HTTP_PORT: 8080
      CELL_ID: ${CELL_ID:-cell-1}
      REGION: ${REGION:-local}
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    profiles:
      - control

  # ============================================
  # MIGRATIONS (One-time)
  # ============================================
  migrate:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: worker
    container_name: linkflow-go-migrate
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-linkflow}:${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD}@linkflow-postgres:5432/${POSTGRES_DB:-linkflow}?sslmode=require&search_path=workflow
    command: >
      sh -c "
        echo 'ðŸ”„ Running Go Engine migrations...' &&
        /app/service --migrate-only || echo 'Migration command not supported' &&
        echo 'âœ… Go Engine migrations complete!'
      "
    networks:
      - linkflow
    profiles:
      - migrate

networks:
  linkflow:
    name: linkflow
    driver: bridge
