# LinkFlow - Production Overrides
# Explicit load only: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# What this adds:
#   - Nginx reverse proxy (ports 80/443)
#   - sslmode=require for Postgres connections
#   - Resource limits (CPU + memory)
#   - Replica counts for horizontal scaling
#   - Production-tuned Postgres config
#   - No volume mounts (code baked into images)
#   - No exposed ports except through nginx

services:
  # ============================================
  # Infrastructure — production tuning
  # ============================================
  postgres:
    command: >
      postgres
        -c config_file=/etc/postgresql/postgresql.conf
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/init:/docker-entrypoint-initdb.d:ro
      - ./infra/postgres/postgresql.prod.conf:/etc/postgresql/postgresql.conf:ro
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
        reservations:
          memory: 1G
          cpus: "1.0"

  redis:
    command: >
      redis-server
        --appendonly yes
        --appendfsync everysec
        --maxmemory 512mb
        --maxmemory-policy noeviction
        --requirepass ${REDIS_PASSWORD}
        --save 900 1
        --save 300 10
        --save 60 10000
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 512M
          cpus: "0.5"

  # ============================================
  # Laravel API — production config
  # ============================================
  api:
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      LOG_LEVEL: warning
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.5"

  queue:
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      LOG_LEVEL: warning
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.5"

  scheduler:
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      LOG_LEVEL: warning
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
    profiles: []

  # ============================================
  # Go Engine — production config with sslmode=require
  # ============================================
  frontend:
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-linkflow}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-linkflow}?sslmode=require&search_path=workflow
      LOG_LEVEL: ${LOG_LEVEL:-info}
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.5"

  history:
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-linkflow}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-linkflow}?sslmode=require&search_path=workflow
      LOG_LEVEL: ${LOG_LEVEL:-info}
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "2.0"
        reservations:
          memory: 512M
          cpus: "1.0"

  matching:
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-linkflow}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-linkflow}?sslmode=require&search_path=workflow
      LOG_LEVEL: ${LOG_LEVEL:-info}
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.5"

  worker:
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-linkflow}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-linkflow}?sslmode=require&search_path=workflow
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NUM_WORKERS: "8"
    deploy:
      replicas: 3
      resources:
        limits:
          memory: 1G
          cpus: "2.0"
        reservations:
          memory: 512M
          cpus: "1.0"

  timer:
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-linkflow}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-linkflow}?sslmode=require&search_path=workflow
      LOG_LEVEL: ${LOG_LEVEL:-info}
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.25"

  visibility:
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-linkflow}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-linkflow}?sslmode=require&search_path=workflow
      LOG_LEVEL: ${LOG_LEVEL:-info}
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.5"

  # ============================================
  # Nginx — production reverse proxy
  # ============================================
  nginx:
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${SSL_CERT_PATH:-./infra/nginx/ssl}:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      api:
        condition: service_healthy
      frontend:
        condition: service_healthy
    profiles: []
